name: mobilecoin-workflow-dev-generate-metadata

on:
  workflow_call:
    inputs:
      docker_org:
        description: Docker image org
        type: string
        required: false
        default: mobilecoin
      previous_release:
        description: Previous release version tag
        type: string
        required: false
        default: 1.1.3-dev
    outputs:
      branch:
        description: Sanitized branch name
        value: ${{ jobs.generate-metadata.outputs.branch }}
      namespace: 
        description: Namespace name generated from sanitized branch.
        value: ${{ jobs.generate-metadata.outputs.branch }}
      tag: 
        description: Artifact (image/chart) tag
        value: ${{ jobs.generate-metadata.outputs.tag }}
      docker_org:
        description: echoed Docker org
        value: ${{ inputs.DOCKER_ORG }}
      previous_release:
        description: echoed previous release version
        value: ${{ inputs.PREVIOUS_RELEASE }}


jobs:
  generate-metadata:
    runs-on: [self-hosted, small]
    outputs:
      branch: ${{ steps.meta.outputs.branch }}
      namespace: ${{ steps.meta.outputs.branch }}
      tag: ${{ steps.meta.outputs.tag }}
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Generate version metadata
      id: meta
      run: |
        .internal-ci/util/metadata.sh

    - name: Print Environment Details
      env:
        NAMESPACE: ${{ steps.meta.outputs.branch }}
        BUILD_TAG: ${{ steps.meta.outputs.tag }}
      run: |
        .internal-ci/util/print_details.sh

    - name: Cache wallet seeds
      id: wallet_seeds
      uses: actions/cache@v3
      with:
        path: |
          .tmp/wallet_seeds
        key: ${{ github.ref_name }}-wallet-seeds

    - name: Create wallet seeds
      run: |
        .internal-ci/util/generate_wallet_seeds.sh
